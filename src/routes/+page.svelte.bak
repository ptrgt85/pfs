<script lang="ts">
  import { onMount } from 'svelte';
  import TreeView from '$lib/components/TreeView.svelte';
  import DataTable from '$lib/components/DataTable.svelte';
  
  let companies: any[] = [];
  let loading = true;
  let selectedNode: { id: number, name?: string, type: string } | null = null;
  let selectedType: string = '';
  let selectedId: string | null = null;
  let currentData: any[] = [];
  let currentColumns: any[] = [];
  let currentTitle = '';
  let loadingData = false;
  let activityLog: Array<{time: string, message: string, type: 'info' | 'success' | 'error' | 'loading'}> = [];
  let expandedNodes = new Set<string>();
  
  onMount(async () => {
    await loadAllData();
  });
  
  async function loadAllData() {
    loading = true;
    addLog('Loading companies...', 'loading');
    try {
      const response = await fetch('/api/companies');
      companies = await response.json();
      addLog(`Loaded ${companies.length} companies`, 'success');
    } catch (error) {
      addLog('Failed to load companies', 'error');
      console.error('Failed to load companies:', error);
    } finally {
      loading = false;
    }
  }
  
  function addLog(message: string, type: 'info' | 'success' | 'error' | 'loading' = 'info') {
    const time = new Date().toLocaleTimeString();
    activityLog = [...activityLog, {time, message, type}].slice(-50);
  }
  
  async function loadTableData(nodeId: number, type: string) {
    loadingData = true;
    const startTime = Date.now();
    addLog(`Querying ${type} data...`, 'loading');
    
    try {
      let endpoint = '';
      let params = '';
      
      switch (type) {
        case 'company':
          endpoint = '/api/projects';
          params = `?companyId=${nodeId}`;
          break;
        case 'project':
          endpoint = '/api/precincts';
          params = `?projectId=${nodeId}`;
          break;
        case 'precinct':
          endpoint = '/api/stages';
          params = `?precinctId=${nodeId}`;
          break;
        case 'stage':
          const [permits, approvals, invoices, lots] = await Promise.all([
            fetch(`/api/permits?stageId=${nodeId}`).then(r => r.json()),
            fetch(`/api/approvals?stageId=${nodeId}`).then(r => r.json()),
            fetch(`/api/invoices?stageId=${nodeId}`).then(r => r.json()),
            fetch(`/api/lots?stageId=${nodeId}`).then(r => r.json())
          ]);
          currentData = [
            ...permits.map((p: any) => ({ ...p, type: 'Permit' })),
            ...approvals.map((a: any) => ({ ...a, type: 'Approval' })),
            ...invoices.map((i: any) => ({ ...i, type: 'Invoice' })),
            ...lots.map((l: any) => ({ ...l, type: 'Lot' }))
          ];
          const elapsed = Date.now() - startTime;
          addLog(`Loaded ${currentData.length} items in ${elapsed}ms`, 'success');
          loadingData = false;
          return;
        case 'lot':
          endpoint = '/api/lot-subgroups';
          params = `?lotId=${nodeId}`;
          break;
      }
      
      const response = await fetch(endpoint + params);
      if (!response.ok) throw new Error(`Failed to fetch ${type} data`);
      currentData = await response.json();
      const elapsed = Date.now() - startTime;
      addLog(`Loaded ${currentData.length} items in ${elapsed}ms`, 'success');
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : 'Unknown error';
      addLog(`ERROR: ${errorMsg}`, 'error');
      console.error('Failed to load table data:', error);
      currentData = [];
    } finally {
      loadingData = false;
    }
  }
  
  async function handleSelect(event: CustomEvent) {
    const { node, type } = event.detail;
    addLog(`Selected ${type}: ${node.name || node.lotNumber || node.id}`, 'info');
    selectedNode = { id: node.id, name: node.name || node.lotNumber, type };
    selectedType = type;
    selectedId = `${type}-${node.id}`;
    
    await loadTableData(node.id, type);
    
    switch (type) {
      case 'company':
        currentTitle = `[CO] ${node.name}`;
        currentColumns = [
          { key: 'id', label: 'ID', sortable: true, width: 80 },
          { key: 'name', label: 'Project', editable: true, sortable: true, width: 300 },
          { key: 'description', label: 'Description', editable: true, width: 400 }
        ];
        break;
      case 'project':
        currentTitle = `[PR] ${node.name}`;
        currentColumns = [
          { key: 'id', label: 'ID', sortable: true, width: 80 },
          { key: 'name', label: 'Precinct', editable: true, sortable: true, width: 300 },
          { key: 'description', label: 'Description', editable: true, width: 400 }
        ];
        break;
      case 'precinct':
        currentTitle = `[PC] ${node.name}`;
        currentColumns = [
          { key: 'id', label: 'ID', sortable: true, width: 80 },
          { key: 'name', label: 'Stage', editable: true, sortable: true, width: 300 },
          { key: 'description', label: 'Description', editable: true, width: 400 }
        ];
        break;
      case 'stage':
        currentTitle = `[ST] ${node.name}`;
        currentColumns = [
          { key: 'type', label: 'Type', sortable: true, width: 100 },
          { key: 'id', label: 'ID', sortable: true, width: 80 },
          { key: 'name', label: 'Name', editable: true, width: 300 },
          { key: 'status', label: 'Status', editable: true, width: 150 }
        ];
        break;
      case 'lot':
        currentTitle = `[LT] Lot ${node.lotNumber}`;
        currentColumns = [
          { key: 'id', label: 'ID', sortable: true, width: 80 },
          { key: 'name', label: 'Subgroup', editable: true, width: 300 },
          { key: 'description', label: 'Description', editable: true, width: 400 }
        ];
        break;
    }
  }
  
  async function handleUpdate(id: number, field: string, value: any) {
    if (!selectedType) return;
    
    const endpoint = selectedType === 'company' ? 'companies' :
                     selectedType === 'project' ? 'projects' :
                     selectedType === 'precinct' ? 'precincts' :
                     selectedType === 'stage' ? 'stages' : 'lots';
    
    try {
      const response = await fetch(`/api/${endpoint}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, [field]: value })
      });
      if (response.ok) {
        const updatedItem = currentData.find(item => item.id === id);
        if (updatedItem) {
          updatedItem[field] = value;
          currentData = [...currentData];
          addLog(`Updated ${field}`, 'success');
        }
      } else {
        addLog('Update failed', 'error');
      }
    } catch (error) {
      console.error('Failed to update:', error);
    }
  }
  
  async function handleDelete(id: number) {
    
    const endpoint = selectedType === 'company' ? 'companies' :
                     selectedType === 'project' ? 'projects' :
                     selectedType === 'precinct' ? 'precincts' :
                     selectedType === 'stage' ? 'stages' : 'lots';
    
    try {
      const response = await fetch(`/api/${endpoint}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      });
      if (response.ok) {
        currentData = currentData.filter(item => item.id !== id);
        addLog('Deleted successfully', 'success');
      } else {
        addLog('Delete failed', 'error');
      }
    } catch (error) {
      console.error('Failed to delete:', error);
    }
  }
  
  async function handleAdd(data: any) {
    if (!selectedType || !selectedNode) return;
    
    const endpoint = selectedType === 'company' ? 'projects' :
                     selectedType === 'project' ? 'precincts' :
                     selectedType === 'precinct' ? 'stages' :
                     selectedType === 'stage' ? 'lots' : 'lot-subgroups';
    
    const parentIdField = selectedType === 'company' ? 'companyId' :
                          selectedType === 'project' ? 'projectId' :
                          selectedType === 'precinct' ? 'precinctId' :
                          selectedType === 'stage' ? 'stageId' : 'lotId';
    
    try {
      const response = await fetch(`/api/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...data, [parentIdField]: selectedNode.id, sortOrder: 0 })
      });
      if (response.ok) {
        const newItem = await response.json();
        currentData = [...currentData, newItem];
        addLog('Created successfully', 'success');
      } else {
        addLog('Create failed', 'error');
      }
    } catch (error) {
      console.error('Failed to create:', error);
    }
  }
</script>

<div class="terminal-container">
  <div class="terminal-header">
    <div class="ascii-art">
      ╔═══════════════════════════════════════════════════════════════╗
      ║  ███████╗██╗██╗     ██╗███╗   ██╗ ██████╗     ███████╗██╗   ║
      ║  ██╔════╝██║██║     ██║████╗  ██║██╔════╝     ██╔════╝╚██╗  ║
      ║  █████╗  ██║██║     ██║██╔██╗ ██║██║  ███╗    ███████╗ ╚██╗ ║
      ║  ██╔══╝  ██║██║     ██║██║╚██╗██║██║   ██║    ╚════██║ ██╔╝ ║
      ║  ██║     ██║███████╗██║██║ ╚████║╚██████╔╝    ███████║██╔╝  ║
      ║  ╚═╝     ╚═╝╚══════╝╚═╝╚═╝  ╚═══╝ ╚═════╝     ╚══════╝╚═╝   ║
      ╚═══════════════════════════════════════════════════════════════╝
    </div>
    <div class="system-info">
      <span class="info-item">[ SYSTEM: FILING-SYS v1.0 ]</span>
      <span class="info-item">[ STATUS: ONLINE ]</span>
      <span class="info-item">[ USER: {companies.length} COMPANIES LOADED ]</span>
    </div>
  </div>
  
  <div class="terminal-body">
    <div class="sidebar">
      <div class="sidebar-header">
        ┌─[ NAVIGATION TREE ]─────────────────┐
      </div>
      <div class="tree-container">
        {#if loading}
          <div class="loading">LOADING DATA...</div>
        {:else}
          <TreeView 
            data={companies}
            {selectedId}
            on:select={handleSelect}
          />
        {/if}
      </div>
      <div class="sidebar-footer">
        └──────────────────────────────────────┘
      </div>
    </div>
    
    <div class="content">
      <div class="content-header">
        ┌─[ {currentTitle || 'SELECT AN ITEM FROM TREE'} ]─────────────────
      </div>
      <div class="content-body">
        {#if loadingData}
          <div class="loading">LOADING DATA...</div>
        {:else if selectedNode}
          <DataTable 
            columns={currentColumns}
            data={currentData}
            onUpdate={handleUpdate}
            onDelete={handleDelete}
            onAdd={handleAdd}
          />
        {:else}
          <div class="welcome">
            <pre class="ascii-welcome">
    ╔════════════════════════════════════════════╗
    ║                                            ║
    ║     WELCOME TO FILING SYSTEM v1.0         ║
    ║                                            ║
    ║  ► Select a company from the tree         ║
    ║  ► Expand nodes to navigate hierarchy     ║
    ║  ► Click any item to view/edit details    ║
    ║                                            ║
    ║  HIERARCHY:                                ║
    ║  Company → Project → Precinct → Stage     ║
    ║           → Permits/Approvals/Invoices    ║
    ║           → Lots → Subgroups              ║
    ║                                            ║
    ╚════════════════════════════════════════════╝
            </pre>
          </div>
        {/if}
      </div>
      <div class="content-footer">
        └────────────────────────────────────────────────────────────────
      </div>
    </div>
  </div>
  
  <div class="log-panel-bottom">
    <div class="log-header">
      ┌─[ ACTIVITY LOG - LATEST FIRST ]─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    </div>
    <div class="log-content">
      {#if activityLog.length === 0}
        <div class="log-empty">No activity yet...</div>
      {:else}
        {#each activityLog.slice().reverse() as log}
          <div class="log-entry log-{log.type}">
            <span class="log-time">[{log.time}]</span>
            <span class="log-message">{log.message}</span>
          </div>
        {/each}
      {/if}
    </div>
  </div>
</div>

<style>
  .terminal-container {
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: #000;
    color: #00ff00;
    overflow: hidden;
  }
  
  .terminal-header {
    border-bottom: 2px solid #00ff00;
    padding: 16px;
    background: #001100;
  }
  
  .ascii-art {
    color: #00ffff;
    font-size: 10px;
    line-height: 1.2;
    white-space: pre;
    text-align: center;
  }
  
  .system-info {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    padding: 8px;
    background: #000;
    border: 1px solid #00ff00;
    font-size: 12px;
  }
  
  .info-item {
    color: #ffff00;
  }
  
  .terminal-body {
    display: flex;
    flex: 1;
    overflow: hidden;
    min-height: 0;
  }
  
  .sidebar {
    width: 300px;
    border-right: 1px solid #00ff00;
    display: flex;
    flex-direction: column;
    background: #000;
    min-height: 0;
  }
  
  .tree-container {
    flex: 1;
    overflow-y: auto;
    min-height: 0;
  }
  
  .log-panel-bottom {
    height: 150px;
    border-top: 1px solid #00ff00;
    display: flex;
    flex-direction: column;
    background: #000;
    flex-shrink: 0;
  }
  
  .log-header {
    padding: 6px 16px;
    color: #00ffff;
    background: #001100;
    border-bottom: 1px solid #00ff00;
    font-size: 11px;
  }
  
  .log-content {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
    font-size: 11px;
    line-height: 1.3;
    min-height: 0;
  }
  
  .log-empty {
    color: #666;
    text-align: center;
    padding: 20px;
  }
  
  .log-entry {
    padding: 4px 8px;
    margin-bottom: 2px;
    border-left: 2px solid transparent;
  }
  
  .log-time {
    color: #666;
    margin-right: 8px;
    font-size: 10px;
  }
  
  .log-message {
    color: #00ff00;
  }
  
  .log-entry.log-info {
    border-left-color: #00ffff;
  }
  
  .log-entry.log-info .log-message {
    color: #00ffff;
  }
  
  .log-entry.log-success {
    border-left-color: #00ff00;
  }
  
  .log-entry.log-success .log-message {
    color: #00ff00;
  }
  
  .log-entry.log-error {
    border-left-color: #ff0000;
    background: #1a0000;
  }
  
  .log-entry.log-error .log-message {
    color: #ff0000;
  }
  
  .log-entry.log-loading {
    border-left-color: #ffff00;
  }
  
  .log-entry.log-loading .log-message {
    color: #ffff00;
    animation: blink 1s infinite;
  }
  
  .sidebar-header,
  .sidebar-footer,
  .content-header,
  .content-footer {
    padding: 8px 16px;
    color: #00ffff;
    background: #001100;
    border-bottom: 1px solid #00ff00;
    font-size: 12px;
  }
  
  .sidebar-footer,
  .content-footer {
    border-bottom: none;
    border-top: 1px solid #00ff00;
  }
  
  .content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 0;
  }
  
  .content-body {
    flex: 1;
    overflow: auto;
    padding: 16px;
  }
  
  .loading {
    text-align: center;
    padding: 40px;
    color: #ffff00;
    font-size: 14px;
    animation: blink 1s infinite;
  }
  
  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
  }
  
  .welcome {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
  }
  
  .ascii-welcome {
    color: #00ffff;
    font-size: 14px;
    line-height: 1.4;
    margin: 0;
  }
</style>
